// The MIT License (MIT)
//
// selective, version 0.1.0
// Copyright (c) 2013-2014, Allen Chen
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
!function(a){"use strict";var b={filter:"*",ignore:null,appendTo:"body",constrainToBounds:!0,snap:!0},c={SELECTEE:"sl-selectee",SELECTING:"sl-selecting",SELECTED:"sl-selected",DESELECTING:"sl-deselecting",DESELECTED:"sl-deselected",CLEAR:"sl-clear",DRAGGED:"sl-dragged",DELETED:"sl-deleted"},d=function(c,d){var e=this;this.$root=c,this.options=a.extend({},b,d),this.$selectbox=a('<div class="sl-selectbox">').hide().appendTo(this.options.appendTo),this.refresh(),this.$root.on("mousedown.selective",function(a){e.onMouseDown(a)}).on("sl-clear-selections.selective",function(){e.clearSelections()}).on("sl-refresh.selective",function(){e.refresh()}).on("sl-destroy.selective",function(){e.destroy()}).attr({tabindex:"0"}).css({outline:"0"}),a(document).on("mousemove.selective",function(a){e.onMouseMove(a)}).on("mouseup.selective",function(a){e.onMouseUp(a)}).on("keydown.selective",function(a){e.onKeyDown(a)})};d.prototype.destroy=function(){this.$root.off(".selective"),a(document).off(".selective"),this.$root=null,this.options=null,this.$selectbox=null,this.bounds=null,this.selectees=null},d.prototype.onMouseDown=function(b){if(0===b.button&&!(a(b.target).filter(this.options.ignore).length>0)){this.mouseStarted&&this.onMouseUp(b),this.mouseStarted=!0,this.refresh();var d=a(b.target).closest("."+c.SELECTEE);d.length>0?d.is(".sl-disabled")?this.mouseStarted=!1:this.isCtrlPressed(b)?this.isSelected(d)?this.setDeselecting(d):(this.setSelecting(d),this.setDragTargets(b.pageX,b.pageY,d)):(this.isSelected(d)||(this.clearSelections(),this.setSelecting(d)),this.setDragTargets(b.pageX,b.pageY,d)):(this.$root.focus(),b.preventDefault(),this.isCtrlPressed(b)||this.clearSelections(),this.$selectbox.css({left:b.pageX,top:b.pageY,width:0,height:0}).data({startX:b.pageX,startY:b.pageY}))}},d.prototype.onMouseMove=function(b){if(this.mouseStarted)if(this.dragStarted=!0,this.dragTargets&&this.dragTargets.length>0){var c=b.pageX-this.dragStart.startX,d=b.pageY-this.dragStart.startY;this.dragTargets.each(function(){var b=a(this).data("sl-position"),e=b.left,f=b.top;a(this).css({position:"absolute",left:e+c,top:f+d})})}else if(this.$selectbox.parent().length>0){var e,f=this.$selectbox.data("startX"),g=this.$selectbox.data("startY"),h=b.pageX,i=b.pageY;this.options.constrainToBounds&&(h<this.bounds.left&&(h=this.bounds.left),h>this.bounds.right&&(h=this.bounds.right),i<this.bounds.top&&(i=this.bounds.top),i>this.bounds.bottom&&(i=this.bounds.bottom)),f>h&&(e=h,h=f,f=e),g>i&&(e=i,i=g,g=e),this.$selectbox.css({left:f,top:g,width:h-f,height:i-g}).show();var j=this;this.selectees.each(function(){var b=a(this),c=a(this).data("sl-bounds"),d=b.is(":visible")&&!(c.left>h||c.right<f||c.top>i||c.bottom<g);d?j.isSelected(b)?j.setDeselecting(b):j.setSelecting(b):j.clearSelecting(b)})}},d.prototype.onMouseUp=function(){if(this.mouseStarted){var b=this;this.mouseStarted=!1,this.dragStarted&&this.dragTargets&&this.dragTargets.length>0&&(this.dragStarted=!1,this.dragTargets.each(function(){a(this).trigger(c.DRAGGED,b.getPosition(a(this)))})),this.dragTargets=null,this.dragStart=null,this.selectees.each(function(){var c=a(this);b.isSelecting(c)?b.setSelected(c):b.isDeselecting(c)&&b.setDeselected(c)}),this.$selectbox.removeAttr("style").hide().removeData()}},d.prototype.refresh=function(){var b=this;this.bounds=this.getBounds(this.$root),this.selectees=this.$root.find(this.options.filter).addClass(c.SELECTEE),this.selectees.each(function(){a(this).data("sl-bounds",b.getBounds(a(this))),a(this).data("sl-position",b.getPosition(a(this)))}),this.snapPoints=this.getSnapPoints()},d.prototype.getSnapPoints=function(){var b={x:{},y:{}};return b.x[this.bounds.left]=1,b.x[this.bounds.right]=1,b.y[this.bounds.top]=1,b.y[this.bounds.bottom]=1,this.selectees.each(function(){var c=a(this).data("sl-bounds");b.x[c.left]=1,b.x[c.right]=1,b.y[c.top]=1,b.y[c.bottom]=1}),b},d.prototype.getBounds=function(a){var b=a.offset();return{left:b.left,right:b.left+a.width(),top:b.top,bottom:b.top+a.height()}},d.prototype.getPosition=function(a){var b={};if("absolute"!==a.css("position")){var c=a.position();b.left=c.left,b.top=c.top}else b.left=parseInt(a.css("left").match(/-?\d*/)[0]),b.top=parseInt(a.css("top").match(/-?\d*/)[0]);return b},d.prototype.isSelectee=function(a){return a.hasClass(c.SELECTEE)},d.prototype.isSelecting=function(a){return a.hasClass(c.SELECTING)},d.prototype.isSelected=function(a){return a.hasClass(c.SELECTED)},d.prototype.isDeselecting=function(a){return a.hasClass(c.DESELECTING)},d.prototype.setSelecting=function(a,b){a.addClass(c.SELECTING),b||a.trigger(c.SELECTING)},d.prototype.clearSelecting=function(a,b){a.removeClass(c.SELECTING).removeClass(c.DESELECTING),b||a.trigger(c.CLEAR)},d.prototype.setSelected=function(a,b){this.clearSelecting(a,!0),a.addClass(c.SELECTED),b||a.trigger(c.SELECTED)},d.prototype.setDeselecting=function(a,b){a.addClass(c.DESELECTING),b||a.trigger(c.DESELECTING)},d.prototype.setDeselected=function(a,b){this.isSelected(a)&&(this.clearSelecting(a,!0),a.removeClass(c.SELECTED),b||a.trigger(c.DESELECTED))},d.prototype.setDragTargets=function(a,b,d){this.dragTargets=this.selectees.filter("."+c.SELECTED).add(d),this.dragStart={startX:a,startY:b}},d.prototype.clearSelections=function(){var b=this;this.selectees.each(function(){b.setDeselected(a(this))})},d.prototype.isCtrlPressed=function(a){return a.ctrlKey||a.metaKey},d.prototype.onKeyDown=function(b){if(this.$root&&this.$root.is(":focus")&&(8===b.keyCode||46===b.keyCode)){b.preventDefault();var d=this;this.selectees.filter("."+c.SELECTED).each(function(){d.setDeselected(a(this)),a(this).trigger(c.DELETED)})}},a.fn.extend({selective:function(b){return this.each(function(){new d(a(this),b)}),this}})}(jQuery);